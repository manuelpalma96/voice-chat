<!DOCTYPE html>
<html>
  <head>
    <title>LiveKit Voice Chat</title>
    <style>
      body {
        font-family: sans-serif;
        background-color: #f0f0f0;
        color: #333;
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 50px;
      }
      #participants {
        margin-top: 20px;
      }
      .participant {
        margin: 5px;
        padding: 10px;
        background-color: #fff;
        border-radius: 5px;
      }
      button {
        margin: 5px;
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        background-color: #007bff;
        color: white;
      }
      #disconnect-btn {
        background-color: #dc3545;
      }
    </style>
  </head>
  <body>
    <div id="login-form">
      <h1>Voice Chat</h1>
      <h2>Ingresa para unirte</h2>
      <input type="text" id="username-input" placeholder="Tu nombre" required />
      <input type="password" id="password-input" placeholder="Contraseña de la sala" required />
      <button id="connect-btn">Entrar a la sala</button>
    </div>
    <div id="room-controls" style="display: none;">
      <button id="disconnect-btn">Salir</button>
      <div id="participants"></div>
    </div>

    <script type="module">
      import {
        Room,
        RoomEvent,
      } from "https://cdn.skypack.dev/livekit-client";

      const loginForm = document.getElementById('login-form');
      const roomControls = document.getElementById('room-controls');
      const connectBtn = document.getElementById("connect-btn");
      const disconnectBtn = document.getElementById("disconnect-btn");
      const participantsDiv = document.getElementById("participants");
      const usernameInput = document.getElementById('username-input');
      const passwordInput = document.getElementById('password-input');

      let room;

      async function connectToRoom() {
        const username = usernameInput.value;
        const password = passwordInput.value;

        if (!username || !password) {
          alert('Por favor, ingresa tu nombre y la contraseña.');
          return;
        }

        const resp = await fetch(`https://voice-chat-8ha4.onrender.com/token?username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`);

        if (!resp.ok) {
          const errorData = await resp.json().catch(() => ({ error: 'Error desconocido del servidor.' }));
          alert(`Error: ${errorData.error}`);
          return;
        }

        const data = await resp.json();
        const token = data.token;

        if (!token) {
          alert('No se pudo obtener un token de acceso. Inténtalo de nuevo.');
          return;
        }

        room = new Room();

        room
          .on(RoomEvent.ParticipantConnected, handleParticipantConnected)
          .on(RoomEvent.ParticipantDisconnected, handleParticipantDisconnected)
          .on(RoomEvent.TrackSubscribed, handleTrackSubscribed)
          .on(RoomEvent.TrackUnsubscribed, handleTrackUnsubscribed)
          .on(RoomEvent.Disconnected, handleDisconnect);

        await room.connect("wss://voice-chat-5qhki9h7.livekit.cloud", token);

        await room.localParticipant.setMicrophoneEnabled(true);
        handleParticipantConnected(room.localParticipant);

        loginForm.style.display = 'none';
        roomControls.style.display = 'block';
      }

      function handleParticipantConnected(participant) {
        const participantDiv = document.createElement("div");
        participantDiv.id = participant.sid;
        participantDiv.className = "participant";
        participantDiv.innerText = participant.identity;
        participantsDiv.appendChild(participantDiv);
      }

      function handleParticipantDisconnected(participant) {
        document.getElementById(participant.sid)?.remove();
      }

      function handleTrackSubscribed(track, publication, participant) {
        if (track.kind === "audio") {
          const element = track.attach();
          document.getElementById(participant.sid)?.appendChild(element);
        }
      }

      function handleTrackUnsubscribed(track, publication, participant) {
        track.detach();
      }

      function handleDisconnect() {
        // El SDK de LiveKit se encarga de detener las pistas al desconectar.
        participantsDiv.innerHTML = "";
        loginForm.style.display = 'block';
        roomControls.style.display = 'none';
      }

      connectBtn.onclick = connectToRoom;
      disconnectBtn.onclick = () => room?.disconnect();
    </script>
  </body>
</html>